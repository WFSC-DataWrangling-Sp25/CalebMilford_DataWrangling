---
title: "Final_Project_Script"
author: "Caleb Milford"
date: "Spring 25"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Installing and loading initial packages

```{r}
# install.packages("tidyverse")
# install.packages("rmarkdown")
# install.packages("terra")
#install.packages("leaflet")

library(tidyverse)
library(rmarkdown)
library(terra)
library(leaflet)
library(htmlwidgets)


```

## My raw data

The data that I am using "Combines_Frog_Project_Data.csv" is the culmination of all the herpetological surveys that have been done over the past three years from the Bullfrog crew that is working throughout southeast Arizona from the Bauder lab. During these surveys they record all herps that are encountered during every survey as well as all other relevant data at the time of encounter. This is everything from the surveyors names, species encountered, location in UTM coordinates, site level covariates like vegetation and much more. My primary goal throughout this script will be to clean and midify this data set so that it is usable for my first thesis chapter.

My thesis chapter will only be looking at two species specifically and doing some occupancy modeling for both of them individually. The two species are the Sonoran mud turtle (*Kinosternon sonoriense*) and the Sonora desert toad (*Incilius alvarius*) and I am primarily interested in how site level and landscape level covariates are affecting the presence/ absence of these two species. Considering this initial data set has a lot of extra information in it. My first goals will be to pull out the appropriate info so I can continue analysis.

**Loading in raw data**

```{r}
#getwd()
all_herp_data <- read_csv("../data_raw/Combined_Frog_Project_Data.csv")
all_herp_data
```

### Week 3: Intro to data frames

Goal is to parse down the data frame and remove unnecessary columns or info that is not relevant to my project

```{r}
#Removing completely unnesesary columns 
all_herp_data2 <- all_herp_data %>% 
  select(-surveyors, -Adult, -Adults_removed, -Juv, -Juv_removed, -Larvae,
         -Larvae_removed, -Egg_mass, -County, -Final_Start_NAD83_East,
         -Final_Start_NAD83_North) %>% 
  rename("Taxon" = taxon) %>% 
  arrange(Date)
         
#Just to more easiliy visualize what I am looking at without so much outside info 
all_herp_data_obrev <- all_herp_data2 %>% 
  select(Date, Start_time, Site_name, Species, No_Obs)
all_herp_data_obrev
```

### Week 6: Cleaning untidy data and Week 4: Group Joins

```{r}
#Replacing unclear notation or 0's with NA's

all_herp_data2 <- all_herp_data2 %>% 
  mutate(Air_temp_150cm_C = na_if(Air_temp_150cm_C, "n/r"), 
         Water_tmp_5cm_C = na_if(Water_tmp_5cm_C, "n/r"),
         Relative_humidity = na_if(Relative_humidity, "n/r"),
         Floating_species = na_if(Floating_species, "0"),
         Submerged_species = na_if(Submerged_species, "0"), 
         Emergent_species = na_if(Emergent_species, "0"))
  
#seperating the date column into day month year columns 
all_herp_data2 <- all_herp_data2 %>% 
  separate(Date, c("Year", "Month", "Day"), sep = "-")

#Changing the data frame to one row per survey instead of one row per 
#species found 
all_herp_data3 <- all_herp_data2 %>%
  group_by(Year, Month, Day, Site_name, Start_time) %>%
  summarise(Species_all = paste(unique(Species), collapse = ", "),
    .groups = "drop")

all_herp_data3 #Each row is now one individual survey

survey_details <- all_herp_data2 %>% 
  select(-Taxon, -Species, -No_Obs, -Disposition, -Comments)
  
  
left_join(all_herp_data3, survey_details, join_by(Year, Month, Day, Site_name, Start_time))

#innerjoin - this actually didnt work, unsure why right now. But one big red flag is No_obs because this is def off for this new dataframe 

#This worked however it did not maintain the orignal data frames number of
#columns. It only gave back the columns I grouped by. Need to come back and
#figure out how to have each row represent 1 survey while maintaining all
#origial columns 



#Summarize detections by month/year for each species 
#This data will help us to determine site closure when lookig at occupancy 
KISO_monthly_det <- all_herp_data3 %>% 
  filter(Species_all == "KISO") %>% 
  group_by(Year, Month) %>% 
  summarise(Detections = n(), .groups = "drop")
KISO_monthly_det

write_csv(KISO_monthly_det, "../data_clean//KISO_monthly_det.csv")

BUAL_monthly_det <- all_herp_data3 %>% 
  filter(Species == "BUAL") %>% 
  group_by(Year, Month) %>% 
  summarise(Detections = n(), .groups = "drop")

write_csv(BUAL_monthly_det, "../data_clean//BUAL_monthly_det.csv")

```

### Summarizing the \# of times each site was surveyed each year

#### Week 6 again

```{r}
#Summarizing the # of times each site was surveyed each year
survey_year_summary <- all_herp_data3 %>% 
  group_by(Site_name, Year) %>% 
  summarise(site_visits = n(), .groups = "drop")

survey_year_summary

#Pivot wider so that columns are designated by years and rows by survey sites 
survey_year_summary <- survey_year_summary %>%
  pivot_wider(names_from = Year,
              values_from = site_visits,
              values_fill = 0  # Fills in 0 where a site has no surveys that year
  )
survey_year_summary

##Note that this was done before dipnet surveys were removed. May need to come back and modify 
```

### Week 5: Data Visualization

```{r}
all_herp_data2 %>% 
  filter(Species == "KISO") %>% 
  ggplot(aes(x = Air_temp_150cm_C, y = Water_tmp_5cm_C))+
  geom_point()+
  labs(x = "Air Temp (C)", y = "Water Temp (C)")+
  theme_bw()

all_herp_data2 %>% 
  filter(Species == "BUAL") %>% 
  ggplot(aes(x = Air_temp_150cm_C, y = Water_tmp_5cm_C))+
  geom_point()+
  labs(x = "Air Temp (C)", y = "Water Temp (C)")+
  theme_bw()


#This part still needs a lot of work dont judge me 
```

### Week 7: Dates and Strings

#### Determining if dipneting can be used as a detection method or can be thrown out

```{r}
#Comparing the detection of my species with the Disposition column 
dispo_test <- all_herp_data2 %>%
  separate(Start_time, c("Hour", "Minute"), sep = 2) %>% 
  mutate(Date_time = make_datetime(year = as.integer(Year), 
                                   month = as.integer(Month),
                                   day = as.integer(Day), 
                                   hour = as.integer(Hour), 
                                   min = as.integer(Minute))) %>% 
  select(Date_time, Site_name, Species, Disposition,
         Comments) %>% 
  filter(Species == "KISO" | Species == "BUAL") %>% 
  arrange(Date_time)

dispo_test

#Confirming that the only time my species were encountered was during 
#"observed", "removed", "none", aka visual surveys 
unique(all_herp_data2$Disposition)
unique(dispo_test$Disposition)

#Also confirming that there wasn't mention of dipetting in the comments 
#These surveys can be thrown out because they were not applicable for detenction
#or occupancy 
str_detect(dispo_test$Comments, "dipnet")


```

### Week 12: Making Choices

#### Creating a new data frame that shows encounter history instead of \# of individuals found using if/else

```{r}

```

### Week 14: Geospacial Data

#### This data has to do with the other half of my thesis. The two chapter are completely unrelated but the main thing I want to do with this data is get a map with Lat/Lon coordinates of my field sites

```{r}
#Loading in Rio Grande Leopard Frog Field Site data 
RABE_data <- read.csv("../data_raw/RABE_SiteQuery_HerpsDB.csv")
summary(RABE_data)
head(RABE_data)

RABE_sites <- RABE_data %>% 
  select(Num, Site, SiteAt, UTMEast_NAD83, UTMNorth_NAD83, Zone) %>% 
  rename(Site_num = "Num")
RABE_sites

# Need to create a SpatVector from UTM coordinates
RABE_sites_vect <- vect(RABE_sites, 
                   geom = c("UTMEast_NAD83", "UTMNorth_NAD83"), 
                   crs = paste0("EPSG:269", unique(RABE_sites$Zone)))

# Reproject to WGS84 (lat/lon)
sites_latlon <- project(RABE_sites_vect, "EPSG:4326")

# Extract coordinates
coords_latlon <- crds(sites_latlon, df = TRUE)

# Add to my original data frame
RABE_sites$Longitude <- coords_latlon[, "x"]
RABE_sites$Latitude <- coords_latlon[, "y"]

RABE_sites
write_csv(RABE_sites, "../data_clean//RABE_sites.csv")

#Now plotting the points on an interactive map 
#I recognize we never used the leaflet package in class but this is very helpful for
#my project so I decided to go for it 

RABE_site_map <- leaflet(data = RABE_sites) %>%
  addTiles() %>%  # Adds the default OpenStreetMap tiles
  addCircleMarkers(
    lng = ~Longitude,
    lat = ~Latitude,
    popup = ~paste0(
      "<strong>Site:</strong> ", Site_num, "<br>",
      "<strong>Latitude:</strong> ", round(Latitude, 5), "<br>",
      "<strong>Longitude:</strong> ", round(Longitude, 5)
    ),
    radius = 5,
    fillColor = "blue",
    color = "black",
    fillOpacity = 0.7
  )
RABE_site_map


#Saving RABE site map in outputs folder 
saveWidget(RABE_site_map, "../outputs/RABE_sites_map.html", selfcontained = TRUE)


#Now doing the same with the KISO/BUAL Data sets 
KISO_BUAL_sites <- all_herp_data2 %>% 
  select(Site_name, Start_NAD83_East, Start_NAD83_North) %>%
  drop_na() %>% 
  distinct(Site_name, Start_NAD83_East, Start_NAD83_North, .keep_all = TRUE)

herp_vect <- vect(KISO_BUAL_sites,
                  geom = c("Start_NAD83_East", "Start_NAD83_North"),
                  crs = "EPSG:26912")

herp_latlon <- project(herp_vect, "EPSG:4326")

coords <- crds(herp_latlon, df = TRUE)

KISO_BUAL_sites$Longitude <- coords$x
KISO_BUAL_sites$Latitude <- coords$y  

KISO_BUAL_sites

KISO_BUAL_site_map <- leaflet(data = KISO_BUAL_sites) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~Longitude,
    lat = ~Latitude,
    popup = ~paste0(
      "<strong>Site Name:</strong> ", Site_name, "<br>",
      "<strong>Latitude:</strong> ", round(Latitude, 5), "<br>",
      "<strong>Longitude:</strong> ", round(Longitude, 5)
    ),
    radius = 5,
    fillColor = "darkgreen",
    color = "black",
    fillOpacity = 0.7
  )
KISO_BUAL_site_map

#Saving KISO_BUAL site map in outputs folder
saveWidget(KISO_BUAL_site_map, "../outputs/KISO_BUAL_site_map.html", selfcontained = TRUE)


```
